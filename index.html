<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel Editor Mobil</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0f1220;
      color: #fff;
    }
    header {
      padding: 12px;
      background: #171a2b;
      text-align: center;
    }
    main {
      padding: 12px;
    }
    .canvas-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }
    canvas {
      width: 100%;
      max-width: 320px;
      height: auto;
      image-rendering: pixelated;
      border: 1px solid #333;
      touch-action: none; /* wichtig f√ºr Finger-Malen */
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .controls button, .controls select, .controls input[type="color"], .controls input[type="file"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      font-size: 14px;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      background: #111;
    }
    .card button {
      width: 100%;
      margin-top: 4px;
      padding: 6px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h2>Pixel Editor Mobil</h2>
  </header>
  <main>
    <div class="canvas-wrap">
      <canvas id="canvas" width="320" height="320"></canvas>
    </div>
    <div class="controls">
      <select id="gridSize">
        <option value="16">16 x 16</option>
        <option value="32">32 x 32</option>
      </select>
      <input type="color" id="colorPicker" value="#000000" />
      <button id="eraser">Radierer</button>
      <button id="clear">Leeren</button>
      <button id="download">Download PNG</button>
      <input type="file" id="fileInput" accept="image/*" />
      <button id="saveUpload">In Galerie speichern</button>
      <button id="showGallery">Galerie anzeigen</button>
    </div>
    <div id="gallery" class="gallery" style="display:none"></div>
  </main>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let gridN = 16;
    let cellSize = canvas.width / gridN;
    let pixels = new Array(gridN*gridN).fill(null);
    let drawing = false;
    let eraserMode = false;

    function setGrid(n) {
      gridN = n;
      cellSize = canvas.width / gridN;
      pixels = new Array(gridN*gridN).fill(null);
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function getCell(x,y) {
      return {cx: Math.floor(x/cellSize), cy: Math.floor(y/cellSize)};
    }

    function paintCell(x,y) {
      const idx = y*gridN+x;
      if (eraserMode) {
        ctx.clearRect(x*cellSize,y*cellSize,cellSize,cellSize);
        pixels[idx]=null;
      } else {
        ctx.fillStyle = colorPicker.value;
        ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
        pixels[idx]=colorPicker.value;
      }
    }

    function handleDraw(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches? e.touches[0].clientX : e.clientX;
      const clientY = e.touches? e.touches[0].clientY : e.clientY;
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      const {cx,cy} = getCell(x,y);
      paintCell(cx,cy);
    }

    canvas.addEventListener('mousedown', e=>{drawing=true;handleDraw(e)});
    canvas.addEventListener('mousemove', e=>{if(drawing)handleDraw(e)});
    window.addEventListener('mouseup', ()=>drawing=false);

    canvas.addEventListener('touchstart', e=>{drawing=true;handleDraw(e)});
    canvas.addEventListener('touchmove', e=>{if(drawing)handleDraw(e)});
    window.addEventListener('touchend', ()=>drawing=false);

    const gridSizeSel=document.getElementById('gridSize');
    const colorPicker=document.getElementById('colorPicker');
    const eraserBtn=document.getElementById('eraser');
    const clearBtn=document.getElementById('clear');
    const downloadBtn=document.getElementById('download');
    const fileInput=document.getElementById('fileInput');
    const saveUploadBtn=document.getElementById('saveUpload');
    const showGalleryBtn=document.getElementById('showGallery');
    const gallery=document.getElementById('gallery');

    gridSizeSel.onchange=()=>setGrid(parseInt(gridSizeSel.value));
    eraserBtn.onclick=()=>eraserMode=!eraserMode;
    clearBtn.onclick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);pixels.fill(null)};
    downloadBtn.onclick=()=>{
      const a=document.createElement('a');
      a.download='pixel.png';
      a.href=canvas.toDataURL();
      a.click();
    };

    const LS_KEY='pixelUploads';
    function getUploads(){return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}
    function setUploads(arr){localStorage.setItem(LS_KEY,JSON.stringify(arr))}
    function renderGallery(){
      gallery.innerHTML='';
      getUploads().forEach((u,i)=>{
        const card=document.createElement('div');
        card.className='card';
        const img=document.createElement('img');
        img.src=u;
        const btn=document.createElement('button');
        btn.textContent='In Editor laden';
        btn.onclick=()=>loadImage(u);
        card.append(img,btn);
        gallery.appendChild(card);
      });
    }
    function loadImage(src){
      const img=new Image();
      img.onload=()=>{ctx.drawImage(img,0,0,canvas.width,canvas.height)};
      img.src=src;
    }

    saveUploadBtn.onclick=()=>{
      const data=canvas.toDataURL();
      const uploads=getUploads();
      uploads.unshift(data);
      setUploads(uploads);
      alert('Gespeichert in Galerie');
    };
    showGalleryBtn.onclick=()=>{
      gallery.style.display=gallery.style.display==='none'?'grid':'none';
      renderGallery();
    };

    setGrid(16);
  </script>
</body>
</html>
